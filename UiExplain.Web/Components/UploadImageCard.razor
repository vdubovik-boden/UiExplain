@using Microsoft.AspNetCore.Components.Forms
@using System
@using System.IO
@rendermode InteractiveServer
<div class="card w-100">
    <div class="card-body">
        <div class="row">
            <div class="col-md-8 align-self-end">
                <h5 class="card-title">Upload Image</h5>
                <p class="card-text">Select an image file to analyze the UI.</p>
                <InputFile OnChange="OnFileSelected" accept="image/*" class="form-control" />
                @if (!string.IsNullOrWhiteSpace(ErrorMessage))
                {
                    <div class="text-danger mt-2">@ErrorMessage</div>
                }
            </div>
            <div class="col-md-4 d-flex align-items-center justify-content-center">
                @if (ImageSrc != null)
                {
                    <img src="@ImageSrc" alt="Selected image" class="img-fluid" style="max-height: 200px; height: auto; width: auto;" />
                }
            </div>
        </div>
    </div>
</div>

@code {
    private const long MaxFileSize = 10 * 1024 * 1024;

    [Parameter]
    public EventCallback<IBrowserFile?> OnImageSelected { get; set; }

    private IBrowserFile? SelectedFile { get; set; }
    private string? ImageSrc { get; set; }
    private string? ErrorMessage { get; set; }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        ErrorMessage = null;
        SelectedFile = e.File;
        ImageSrc = null;

        if (SelectedFile == null)
        {
            await OnImageSelected.InvokeAsync(null);
            return;
        }

        if (!SelectedFile.ContentType.StartsWith("image/", StringComparison.OrdinalIgnoreCase))
        {
            ErrorMessage = "Please select a valid image file.";
            SelectedFile = null;
            await OnImageSelected.InvokeAsync(null);
            return;
        }

        if (SelectedFile.Size > MaxFileSize)
        {
            ErrorMessage = "Image is too large. Maximum size is 10 MB.";
            SelectedFile = null;
            await OnImageSelected.InvokeAsync(null);
            return;
        }

        await using var stream = SelectedFile.OpenReadStream(MaxFileSize);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        var bytes = ms.ToArray();
        ImageSrc = $"data:{SelectedFile.ContentType};base64,{Convert.ToBase64String(bytes)}";

        await OnImageSelected.InvokeAsync(SelectedFile);
    }
}